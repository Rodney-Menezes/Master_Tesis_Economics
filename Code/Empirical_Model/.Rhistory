# 0.1) winsorize “raw” para leverage y dd
winsorize <- function(x, p = 0.005) {
lo <- quantile(x, p, na.rm = TRUE)
hi <- quantile(x, 1 - p, na.rm = TRUE)
pmin(pmax(x, lo), hi)
}
# helper: winsorize and de-mean leverage and dd within firm
prep_fin_vars <- function(df, p = 0.005) {
df %>%
group_by(name) %>%
mutate(
leverage_win = winsorize(leverage, p = p),
dd_win       = winsorize(dd, p = p),
lev_dm       = leverage_win - mean(leverage_win, na.rm = TRUE),
dd_dm        = dd_win       - mean(dd_win,       na.rm = TRUE)
) %>%
ungroup()
}
# helper: winsorize and standardize the monetary shock within country
prep_shock_var <- function(df, p = 0.005) {
safe_zscore <- function(x) {
mu <- mean(x, na.rm = TRUE)
sigma <- sd(x, na.rm = TRUE)
if (!is.finite(sigma) || sigma == 0) {
return(ifelse(is.na(x), NA_real_, 0))
}
(x - mu) / sigma
}
df %>%
group_by(Country) %>%
mutate(
shock_win = winsorize(shock, p = p),
shock     = safe_zscore(shock_win)
) %>%
ungroup()
}
# 1) Leer base de datos y convertir fecha a trimestral
# --------------------------------------------------------
ruta_dta <- "C:/Users/joser/Downloads/Tesis Master/Data Tesis/Data Final/Data_Base_final.dta"
df <- read_dta(ruta_dta) %>%
mutate(dateq = as.yearqtr(dateq)) %>%
arrange(name, dateq)
# 2) Preprocesamiento: dlog_capital, shock y winsorize leverage/dd
# --------------------------------------------------------
df <- df %>%
arrange(name, dateq) %>%
group_by(name) %>%
mutate(
ratio_cap    = real_capital / lag(real_capital),
dlog_capital = suppressWarnings(ifelse(ratio_cap > 0, log(ratio_cap), NA_real_)),
dlog_capital = ifelse(is.finite(dlog_capital), dlog_capital, NA_real_),
shock        = -shock
) %>%
select(-ratio_cap) %>%
ungroup() %>%
filter(!is.na(dlog_capital)) %>%
prep_fin_vars()
# 3) Calcular dlog_gdp a nivel país y unirlo
# --------------------------------------------------------
gdp_country <- df %>%
distinct(Country, dateq, gdp) %>%
arrange(Country, dateq) %>%
group_by(Country) %>%
mutate(dlog_gdp = log(gdp) - log(lag(gdp))) %>%
ungroup()
df <- df %>%
left_join(gdp_country %>% select(Country, dateq, dlog_gdp),
by = c("Country", "dateq"))
# =================================================================
# Figure 1: Respuesta dinámica de la inversión al shock monetario
# =================================================================
# Parte 1: Sin controles cíclicos
# =================================================================
# 1) Controles firm-level y estandarización de ventas, tamaño y liquidez
if (!"rsales_g_std" %in% names(df)) {
df <- df %>%
group_by(name) %>%
arrange(dateq) %>%
mutate(
rsales_g_std = {
x <- log(saleq) - log(lag(saleq))
(x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
}
) %>%
ungroup()
}
if (!"size_index" %in% names(df)) {
df <- df %>%
group_by(name) %>%
arrange(dateq) %>%
mutate(
size_index = {
x <- log(atq)
(x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
}
) %>%
ungroup()
}
if (!"sh_current_a_std" %in% names(df)) {
df <- df %>%
group_by(name) %>%
arrange(dateq) %>%
mutate(
sh_current_a_std = {
x <- current_ratio
(x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
}
) %>%
ungroup()
}
# 2) Crear interacciones “raw” (winsorizadas) con el shock
df <- df %>%
mutate(
lev_shock = lev_dm * shock,
d2d_shock = dd_dm  * shock
)
# 3) Construir cumFh_dlog_capital para h = 0…12
# --------------------------------------------------------
vars_cap <- paste0("cumF", 0:12, "_dlog_capital")
if (!all(vars_cap %in% names(df))) {
df_dyn_nocy <- df %>%
group_by(name) %>%
arrange(dateq) %>%
group_modify(~ {
tmp <- .x
for (h in 0:12) {
tmp[[paste0("cumF", h, "_dlog_capital")]] <-
rowSums(map_dfc(0:h, ~ lead(tmp$dlog_capital, .x)), na.rm = TRUE)
}
tmp
}) %>%
ungroup()
} else {
df_dyn_nocy <- df
}
# 4) Definir controles y cadena de regresores
controls_firm   <- c("rsales_g_std", "size_index", "sh_current_a_std")
controls_macro  <- intersect(c("dlog_gdp", "dlog_cpi", "unemp", "embigl"), names(df_dyn_nocy))
all_controls_nocy <- paste(c(controls_firm, controls_macro), collapse = " + ")
# 5) Estimar dinámicas h = 0…12 sin componente cíclico
res_lev_nocy <- map(, function(h) {
feols(
as.formula(paste0(
"cumF", h, "_dlog_capital ~ lev_shock + ", all_controls_nocy,
" | Country + dateq"
)),
data    = df_dyn_nocy,
cluster = ~ Country + dateq
)
})
#=====================================================
# Tesis: 'Efectos de la política monetaria sobre la dinámica de inversión en
#         Economías Latinoamericanas mediante un modelo
#         con empresas heterogéneas'
# Autor: Jose Rodney Menezes De la Cruz
# Sumbit: 2025
#=====================================================
# =======================================================
# Dynamic Local Projections - Modelos con Inversion Neta
# =======================================================
# 0) Cargar librerías necesarias
# --------------------------------------------------------
library(haven)
library(zoo)
library(dplyr)
library(purrr)
library(fixest)
library(readr)
library(broom)
library(ggplot2)
library(patchwork)
library(tidyr)
library(kableExtra)
# 0.1) winsorize “raw” para leverage y dd
winsorize <- function(x, p = 0.005) {
lo <- quantile(x, p, na.rm = TRUE)
hi <- quantile(x, 1 - p, na.rm = TRUE)
pmin(pmax(x, lo), hi)
}
# helper: winsorize and de-mean leverage and dd within firm
prep_fin_vars <- function(df, p = 0.005) {
df %>%
group_by(name) %>%
mutate(
leverage_win = winsorize(leverage, p = p),
dd_win       = winsorize(dd, p = p),
lev_dm       = leverage_win - mean(leverage_win, na.rm = TRUE),
dd_dm        = dd_win       - mean(dd_win,       na.rm = TRUE)
) %>%
ungroup()
}
# helper: winsorize and standardize the monetary shock within country
prep_shock_var <- function(df, p = 0.005) {
safe_zscore <- function(x) {
mu <- mean(x, na.rm = TRUE)
sigma <- sd(x, na.rm = TRUE)
if (!is.finite(sigma) || sigma == 0) {
return(ifelse(is.na(x), NA_real_, 0))
}
(x - mu) / sigma
}
df %>%
group_by(Country) %>%
mutate(
shock_win = winsorize(shock, p = p),
shock     = safe_zscore(shock_win)
) %>%
ungroup()
}
# 1) Leer base de datos y convertir fecha a trimestral
# --------------------------------------------------------
ruta_dta <- "C:/Users/joser/Downloads/Tesis Master/Data Tesis/Data Final/Data_Base_final.dta"
df <- read_dta(ruta_dta) %>%
mutate(dateq = as.yearqtr(dateq)) %>%
arrange(name, dateq)
# 2) Preprocesamiento: dlog_capital, shock y winsorize leverage/dd
# --------------------------------------------------------
df <- df %>%
arrange(name, dateq) %>%
group_by(name) %>%
mutate(
ratio_cap    = real_capital / lag(real_capital),
dlog_capital = suppressWarnings(ifelse(ratio_cap > 0, log(ratio_cap), NA_real_)),
dlog_capital = ifelse(is.finite(dlog_capital), dlog_capital, NA_real_),
shock        = -shock
) %>%
select(-ratio_cap) %>%
ungroup() %>%
filter(!is.na(dlog_capital)) %>%
prep_fin_vars()
# 3) Calcular dlog_gdp a nivel país y unirlo
# --------------------------------------------------------
gdp_country <- df %>%
distinct(Country, dateq, gdp) %>%
arrange(Country, dateq) %>%
group_by(Country) %>%
mutate(dlog_gdp = log(gdp) - log(lag(gdp))) %>%
ungroup()
df <- df %>%
left_join(gdp_country %>% select(Country, dateq, dlog_gdp),
by = c("Country", "dateq"))
# =================================================================
# Figure 1: Respuesta dinámica de la inversión al shock monetario
# =================================================================
# Parte 1: Sin controles cíclicos
# =================================================================
# 1) Controles firm-level y estandarización de ventas, tamaño y liquidez
if (!"rsales_g_std" %in% names(df)) {
df <- df %>%
group_by(name) %>%
arrange(dateq) %>%
mutate(
rsales_g_std = {
x <- log(saleq) - log(lag(saleq))
(x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
}
) %>%
ungroup()
}
if (!"size_index" %in% names(df)) {
df <- df %>%
group_by(name) %>%
arrange(dateq) %>%
mutate(
size_index = {
x <- log(atq)
(x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
}
) %>%
ungroup()
}
if (!"sh_current_a_std" %in% names(df)) {
df <- df %>%
group_by(name) %>%
arrange(dateq) %>%
mutate(
sh_current_a_std = {
x <- current_ratio
(x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
}
) %>%
ungroup()
}
# 2) Crear interacciones “raw” (winsorizadas) con el shock
df <- df %>%
mutate(
lev_shock = lev_dm * shock,
d2d_shock = dd_dm  * shock
)
# 3) Construir cumFh_dlog_capital para h = 0…12
# --------------------------------------------------------
vars_cap <- paste0("cumF", 0:12, "_dlog_capital")
if (!all(vars_cap %in% names(df))) {
df_dyn_nocy <- df %>%
group_by(name) %>%
arrange(dateq) %>%
group_modify(~ {
tmp <- .x
for (h in 0:12) {
tmp[[paste0("cumF", h, "_dlog_capital")]] <-
rowSums(map_dfc(0:h, ~ lead(tmp$dlog_capital, .x)), na.rm = TRUE)
}
tmp
}) %>%
ungroup()
} else {
df_dyn_nocy <- df
}
# 4) Definir controles y cadena de regresores
controls_firm   <- c("rsales_g_std", "size_index", "sh_current_a_std")
controls_macro  <- intersect(c("dlog_gdp", "dlog_cpi", "unemp", "embigl"), names(df_dyn_nocy))
all_controls_nocy <- paste(c(controls_firm, controls_macro), collapse = " + ")
# 5) Estimar dinámicas h = 0…12 sin componente cíclico
res_lev_nocy <- map(, function(h) {
feols(
as.formula(paste0(
"cumF", h, "_dlog_capital ~ lev_shock + ", all_controls_nocy,
" | name + sec + dateq"
)),
data    = df_dyn_nocy,
cluster = ~ Country
)
})
#=====================================================
# Tesis: 'Efectos de la política monetaria sobre la dinámica de inversión en
#         Economías Latinoamericanas mediante un modelo
#         con empresas heterogéneas'
# Autor: Jose Rodney Menezes De la Cruz
# Sumbit: 2025
#=====================================================
# =======================================================
# Dynamic Local Projections - Modelos con Inversion Neta
# =======================================================
# 0) Cargar librerías necesarias
# --------------------------------------------------------
library(haven)
library(zoo)
library(dplyr)
library(purrr)
library(fixest)
library(readr)
library(broom)
library(ggplot2)
library(patchwork)
library(tidyr)
library(kableExtra)
# 0.1) winsorize “raw” para leverage y dd
winsorize <- function(x, p = 0.005) {
lo <- quantile(x, p, na.rm = TRUE)
hi <- quantile(x, 1 - p, na.rm = TRUE)
pmin(pmax(x, lo), hi)
}
# helper: winsorize and de-mean leverage and dd within firm
prep_fin_vars <- function(df, p = 0.005) {
df %>%
group_by(name) %>%
mutate(
leverage_win = winsorize(leverage, p = p),
dd_win       = winsorize(dd, p = p),
lev_dm       = leverage_win - mean(leverage_win, na.rm = TRUE),
dd_dm        = dd_win       - mean(dd_win,       na.rm = TRUE)
) %>%
ungroup()
}
# helper: winsorize and standardize the monetary shock within country
prep_shock_var <- function(df, p = 0.005) {
safe_zscore <- function(x) {
mu <- mean(x, na.rm = TRUE)
sigma <- sd(x, na.rm = TRUE)
if (!is.finite(sigma) || sigma == 0) {
return(ifelse(is.na(x), NA_real_, 0))
}
(x - mu) / sigma
}
df %>%
group_by(Country) %>%
mutate(
shock_win = winsorize(shock, p = p),
shock     = safe_zscore(shock_win)
) %>%
ungroup()
}
# 1) Leer base de datos y convertir fecha a trimestral
# --------------------------------------------------------
ruta_dta <- "C:/Users/joser/Downloads/Tesis Master/Data Tesis/Data Final/Data_Base_final.dta"
df <- read_dta(ruta_dta) %>%
mutate(dateq = as.yearqtr(dateq)) %>%
arrange(name, dateq)
# 2) Preprocesamiento: dlog_capital, shock y winsorize leverage/dd
# --------------------------------------------------------
df <- df %>%
arrange(name, dateq) %>%
group_by(name) %>%
mutate(
ratio_cap    = real_capital / lag(real_capital),
dlog_capital = suppressWarnings(ifelse(ratio_cap > 0, log(ratio_cap), NA_real_)),
dlog_capital = ifelse(is.finite(dlog_capital), dlog_capital, NA_real_),
shock        = -shock
) %>%
select(-ratio_cap) %>%
ungroup() %>%
filter(!is.na(dlog_capital)) %>%
prep_fin_vars()
# 3) Calcular dlog_gdp a nivel país y unirlo
# --------------------------------------------------------
gdp_country <- df %>%
distinct(Country, dateq, gdp) %>%
arrange(Country, dateq) %>%
group_by(Country) %>%
mutate(dlog_gdp = log(gdp) - log(lag(gdp))) %>%
ungroup()
df <- df %>%
left_join(gdp_country %>% select(Country, dateq, dlog_gdp),
by = c("Country", "dateq"))
# =================================================================
# Figure 1: Respuesta dinámica de la inversión al shock monetario
# =================================================================
# Parte 1: Sin controles cíclicos
# =================================================================
# 1) Controles firm-level y estandarización de ventas, tamaño y liquidez
if (!"rsales_g_std" %in% names(df)) {
df <- df %>%
group_by(name) %>%
arrange(dateq) %>%
mutate(
rsales_g_std = {
x <- log(saleq) - log(lag(saleq))
(x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
}
) %>%
ungroup()
}
if (!"size_index" %in% names(df)) {
df <- df %>%
group_by(name) %>%
arrange(dateq) %>%
mutate(
size_index = {
x <- log(atq)
(x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
}
) %>%
ungroup()
}
if (!"sh_current_a_std" %in% names(df)) {
df <- df %>%
group_by(name) %>%
arrange(dateq) %>%
mutate(
sh_current_a_std = {
x <- current_ratio
(x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
}
) %>%
ungroup()
}
# 2) Crear interacciones “raw” (winsorizadas) con el shock
df <- df %>%
mutate(
lev_shock = lev_dm * shock,
d2d_shock = dd_dm  * shock
)
# 3) Construir cumFh_dlog_capital para h = 0…12
# --------------------------------------------------------
vars_cap <- paste0("cumF", 0:12, "_dlog_capital")
if (!all(vars_cap %in% names(df))) {
df_dyn_nocy <- df %>%
group_by(name) %>%
arrange(dateq) %>%
group_modify(~ {
tmp <- .x
for (h in 0:12) {
tmp[[paste0("cumF", h, "_dlog_capital")]] <-
rowSums(map_dfc(0:h, ~ lead(tmp$dlog_capital, .x)), na.rm = TRUE)
}
tmp
}) %>%
ungroup()
} else {
df_dyn_nocy <- df
}
# 4) Definir controles y cadena de regresores
controls_firm   <- c("rsales_g_std", "size_index", "sh_current_a_std")
controls_macro  <- intersect(c("dlog_gdp", "dlog_cpi", "unemp", "embigl"), names(df_dyn_nocy))
all_controls_nocy <- paste(c(controls_firm, controls_macro), collapse = " + ")
# 5) Estimar dinámicas h = 0…12 sin componente cíclico
res_lev_nocy <- map(0:12, function(h) {
feols(
as.formula(paste0(
"cumF", h, "_dlog_capital ~ lev_shock + ", all_controls_nocy,
" | name + sec + dateq"
)),
data    = df_dyn_nocy,
cluster = ~ Country
)
})
res_dd_nocy <- map(0:12, function(h) {
feols(
as.formula(paste0(
"cumF", h, "_dlog_capital ~ d2d_shock + ", all_controls_nocy,
" | name + sec + dateq"
)),
data    = df_dyn_nocy,
cluster = ~ Country
)
})
# 6) Extraer coeficientes y errores estándar
dyn_lev_nocy <- tibble(
horizon = ,
beta    = map_dbl(res_lev_nocy, ~ coef(.x)["lev_shock"]),
se      = map_dbl(res_lev_nocy, ~ sqrt(vcov(.x)["lev_shock","lev_shock"]))
)
